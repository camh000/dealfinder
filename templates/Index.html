<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PC Deal Finder</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg:       #080c10;
            --surface:  #0d1117;
            --border:   #1c2a3a;
            --green:    #00e5a0;
            --green-dim:#00704e;
            --amber:    #f5a623;
            --red:      #ff4d6d;
            --text:     #c9d8e8;
            --muted:    #4a6278;
            --mono:     'Share Tech Mono', monospace;
            --sans:     'Barlow Condensed', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: var(--mono);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Scanline overlay */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,0,0,0.08) 2px,
                rgba(0,0,0,0.08) 4px
            );
            pointer-events: none;
            z-index: 100;
        }

        header {
            border-bottom: 1px solid var(--border);
            padding: 20px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background: rgba(8,12,16,0.95);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .logo {
            font-family: var(--sans);
            font-weight: 700;
            font-size: 22px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--green);
            text-shadow: 0 0 20px rgba(0,229,160,0.4);
        }

        .logo span { color: var(--muted); }

        .status-bar {
            display: flex;
            gap: 30px;
            font-size: 11px;
            color: var(--muted);
        }

        .status-bar .val { color: var(--text); }

        .pulse {
            display: inline-block;
            width: 7px; height: 7px;
            border-radius: 50%;
            background: var(--green);
            box-shadow: 0 0 8px var(--green);
            animation: pulse 2s ease-in-out infinite;
            margin-right: 6px;
            vertical-align: middle;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Tab bar */
        .tab-bar {
            display: flex;
            gap: 0;
            padding: 0 40px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
        }

        .tab-btn {
            font-family: var(--sans);
            font-weight: 600;
            font-size: 12px;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--muted);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 14px 24px;
            cursor: pointer;
            transition: color 0.2s, border-color 0.2s;
        }

        .tab-btn:hover { color: var(--text); }

        .tab-btn.active {
            color: var(--green);
            border-bottom-color: var(--green);
        }

        .tab-badge {
            display: none;
            background: var(--green);
            color: var(--bg);
            font-family: var(--sans);
            font-size: 10px;
            font-weight: 700;
            line-height: 1;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 7px;
            vertical-align: middle;
        }

        .tab-badge.visible { display: inline-block; }
        .tab-btn:not(.active) .tab-badge { background: var(--green-dim); color: var(--text); }

        main { padding: 30px 40px; max-width: 1400px; margin: 0 auto; }

        .section-header {
            display: flex;
            align-items: baseline;
            gap: 16px;
            margin-bottom: 20px;
        }

        .section-title {
            font-family: var(--sans);
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: var(--muted);
        }

        .deal-count {
            font-size: 11px;
            color: var(--green);
            background: rgba(0,229,160,0.08);
            border: 1px solid rgba(0,229,160,0.2);
            padding: 2px 10px;
            border-radius: 2px;
        }

        .refresh-btn {
            margin-left: auto;
            background: none;
            border: 1px solid var(--border);
            color: var(--muted);
            font-family: var(--mono);
            font-size: 11px;
            padding: 5px 14px;
            cursor: pointer;
            letter-spacing: 1px;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            border-color: var(--green);
            color: var(--green);
        }

        .refresh-btn.spinning { animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Table */
        .table-wrap {
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead tr {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
        }

        th {
            font-family: var(--sans);
            font-weight: 600;
            font-size: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--muted);
            padding: 12px 16px;
            text-align: left;
            white-space: nowrap;
        }

        th.right { text-align: right; }

        tbody tr {
            border-bottom: 1px solid rgba(28,42,58,0.5);
            transition: background 0.15s;
            animation: fadeIn 0.4s ease both;
        }

        tbody tr:hover { background: rgba(255,255,255,0.02); }
        tbody tr:last-child { border-bottom: none; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        td {
            padding: 13px 16px;
            vertical-align: middle;
        }

        .model-cell {
            font-family: var(--sans);
            font-weight: 600;
            font-size: 15px;
            color: #e8f0f8;
            letter-spacing: 0.5px;
        }

        .brand-tag {
            font-size: 10px;
            color: var(--muted);
            margin-top: 2px;
        }

        .price-current {
            font-size: 15px;
            color: var(--amber);
            font-weight: bold;
        }

        .price-avg {
            font-size: 11px;
            color: var(--muted);
            margin-top: 2px;
        }

        .gain {
            color: var(--green);
            font-weight: bold;
            font-size: 14px;
        }

        .discount-badge {
            display: inline-block;
            background: rgba(0,229,160,0.1);
            border: 1px solid rgba(0,229,160,0.25);
            color: var(--green);
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 2px;
            font-family: var(--sans);
            font-weight: 700;
            letter-spacing: 1px;
        }

        .discount-badge.high {
            background: rgba(245,166,35,0.1);
            border-color: rgba(245,166,35,0.3);
            color: var(--amber);
        }

        .time-cell { color: var(--text); font-size: 13px; }
        .time-cell.urgent { color: var(--red); animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0.4; } }

        .link-btn {
            display: inline-block;
            border: 1px solid var(--border);
            color: var(--muted);
            font-family: var(--mono);
            font-size: 11px;
            padding: 5px 12px;
            text-decoration: none;
            transition: all 0.2s;
            letter-spacing: 1px;
        }

        .link-btn:hover {
            border-color: var(--amber);
            color: var(--amber);
        }

        /* Empty / loading / error states */
        .state-row td {
            text-align: center;
            padding: 60px;
            color: var(--muted);
            font-size: 13px;
        }

        .loader {
            display: inline-block;
            width: 14px; height: 14px;
            border: 2px solid var(--border);
            border-top-color: var(--green);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        footer {
            border-top: 1px solid var(--border);
            padding: 20px 40px;
            font-size: 11px;
            color: var(--muted);
            text-align: center;
            letter-spacing: 1px;
            margin-top: 40px;
        }

        /* ── Outcomes panel ──────────────────────────────────── */
        .outcome-stats {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .stat-card {
            border: 1px solid var(--border);
            background: var(--surface);
            padding: 14px 20px;
            flex: 1;
            min-width: 100px;
        }

        .stat-label {
            font-family: var(--sans);
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .stat-value {
            font-family: var(--sans);
            font-size: 26px;
            font-weight: 700;
            color: var(--text);
        }

        .stat-value.green { color: var(--green); }
        .stat-value.amber { color: var(--amber); }

        .subsection-header {
            font-family: var(--sans);
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 24px 0 12px;
        }

        .subsection-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .cat-badge {
            font-family: var(--sans);
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 2px 6px;
            border-radius: 2px;
            color: var(--muted);
            border: 1px solid var(--border);
        }

        .outcome-win {
            display: inline-block;
            background: rgba(0,229,160,0.1);
            border: 1px solid rgba(0,229,160,0.25);
            color: var(--green);
            font-family: var(--sans);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 2px;
        }

        .outcome-miss {
            display: inline-block;
            background: rgba(255,77,109,0.1);
            border: 1px solid rgba(255,77,109,0.25);
            color: var(--red);
            font-family: var(--sans);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 2px;
        }

        .outcome-ended {
            display: inline-block;
            background: rgba(150,150,150,0.1);
            border: 1px solid rgba(150,150,150,0.3);
            color: #888;
            font-family: var(--sans);
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 3px 8px;
            border-radius: 2px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

        /* ── Mobile ──────────────────────────────────────────── */
        @media (max-width: 640px) {
            header {
                padding: 14px 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .status-bar { gap: 14px; flex-wrap: wrap; }

            .tab-bar { padding: 0; }
            .tab-btn { flex: 1; padding: 13px 0; font-size: 11px; letter-spacing: 2px; text-align: center; }

            main { padding: 16px; }
            footer { padding: 16px; font-size: 10px; letter-spacing: 0; }

            /* Card layout — convert table rows to stacked cards */
            .table-wrap { border-left: none; border-right: none; border-radius: 0; }
            table, tbody, tr { display: block; width: 100%; }
            thead { display: none; }

            tbody tr {
                padding: 14px 16px;
                border-bottom: 1px solid var(--border);
            }

            td {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 5px 0;
                border: none;
                text-align: left !important;
            }

            /* Label injected from data-label attribute */
            td[data-label]::before {
                content: attr(data-label);
                font-family: var(--sans);
                font-size: 10px;
                letter-spacing: 1px;
                text-transform: uppercase;
                color: var(--muted);
                min-width: 72px;
                flex-shrink: 0;
            }

            /* Card header — model/capacity line */
            td.card-title {
                display: block;
                padding-bottom: 10px;
                margin-bottom: 6px;
                border-bottom: 1px solid rgba(28,42,58,0.6);
            }

            /* VIEW button — full width */
            td.card-action {
                display: flex;
                margin-top: 10px;
                padding-top: 10px;
                border-top: 1px solid rgba(28,42,58,0.6);
                justify-content: stretch;
            }
            .link-btn {
                display: block;
                width: 100%;
                text-align: center;
                padding: 11px;
                font-size: 12px;
            }

            .state-row td { display: block; padding: 40px 20px; text-align: center !important; }

            /* .price-avg shown with its own data-label row on mobile */
        }
    </style>
</head>
<body>

<header>
    <div class="logo">PC<span>/</span>DEALS</div>
    <div class="status-bar">
        <span><span class="pulse"></span>LIVE</span>
        <span>ACTIVE <span class="val" id="stat-active">—</span></span>
        <span>SOLD <span class="val" id="stat-sold">—</span></span>
        <span>UPDATED <span class="val" id="stat-updated">—</span></span>
    </div>
</header>

<div class="tab-bar">
    <button class="tab-btn active" data-type="gpu" onclick="switchTab('gpu')">GPU<span class="tab-badge" id="badge-gpu"></span></button>
    <button class="tab-btn" data-type="cpu" onclick="switchTab('cpu')">CPU<span class="tab-badge" id="badge-cpu"></span></button>
    <button class="tab-btn" data-type="hdd" onclick="switchTab('hdd')">HDD<span class="tab-badge" id="badge-hdd"></span></button>
    <button class="tab-btn" data-type="outcomes" onclick="switchTab('outcomes')">OUTCOMES</button>
</div>

<main>
    <div id="panel-deals">
        <div class="section-header">
            <span class="section-title">Active Deals</span>
            <span class="deal-count" id="deal-count">— deals</span>
            <button class="refresh-btn" id="refresh-btn" onclick="loadDeals()">↻ REFRESH</button>
        </div>

        <div class="table-wrap">
            <table>
                <thead id="deals-head"></thead>
                <tbody id="deals-body">
                    <tr class="state-row">
                        <td colspan="8"><span class="loader"></span> Loading deals...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="panel-outcomes" style="display:none">
        <div id="outcome-stats" class="outcome-stats"></div>

        <div class="subsection-header">Resolved</div>
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>Surfaced</th>
                        <th>Cat</th>
                        <th>Model</th>
                        <th class="right">Surfaced @</th>
                        <th class="right">Market Avg</th>
                        <th class="right">Final Sale</th>
                        <th>Outcome</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="outcomes-resolved-body">
                    <tr class="state-row"><td colspan="8"><span class="loader"></span> Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="subsection-header" id="pending-header" style="display:none">Pending / Awaiting Result</div>
        <div class="table-wrap" id="pending-wrap" style="display:none">
            <table>
                <thead>
                    <tr>
                        <th>Surfaced</th>
                        <th>Cat</th>
                        <th>Model</th>
                        <th class="right">Surfaced @</th>
                        <th class="right">Market Avg</th>
                        <th class="right">Current</th>
                        <th>Ends</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="outcomes-pending-body"></tbody>
            </table>
        </div>
    </div>
</main>

<footer>PC DEAL FINDER &mdash; AUTO-REFRESHES EVERY 5 MIN &mdash; DATA VIA EBAY UK</footer>

<script>
    let activeType = 'gpu';

    const HEADERS = {
        gpu: `<tr>
            <th>Model</th>
            <th class="right">Current</th>
            <th class="right">Avg Market</th>
            <th class="right">You Save</th>
            <th>Discount</th>
            <th>Ends In</th>
            <th></th>
        </tr>`,
        cpu: `<tr>
            <th>Model</th>
            <th>Socket / Cores</th>
            <th class="right">Current</th>
            <th class="right">Avg Market</th>
            <th class="right">You Save</th>
            <th>Discount</th>
            <th>Ends In</th>
            <th></th>
        </tr>`,
        hdd: `<tr>
            <th>Capacity</th>
            <th>Details</th>
            <th class="right">Current</th>
            <th class="right">Avg Market</th>
            <th class="right">You Save</th>
            <th>Discount</th>
            <th>Ends In</th>
            <th></th>
        </tr>`,
    };

    const COLS = { gpu: 7, cpu: 8, hdd: 8 };

    function switchTab(type) {
        activeType = type;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.type === type);
        });
        const isOutcomes = type === 'outcomes';
        document.getElementById('panel-deals').style.display    = isOutcomes ? 'none' : '';
        document.getElementById('panel-outcomes').style.display = isOutcomes ? '' : 'none';
        if (isOutcomes) {
            loadOutcomes();
        } else {
            loadDeals();
        }
    }

    function formatDate(isoStr) {
        if (!isoStr) return '—';
        const d = new Date(isoStr);
        if (isNaN(d)) return '—';
        const date = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
        const time = d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        return `${date} ${time}`;
    }

    async function loadOutcomes() {
        document.getElementById('outcomes-resolved-body').innerHTML =
            '<tr class="state-row"><td colspan="8"><span class="loader"></span> Loading...</td></tr>';
        try {
            const res  = await fetch('/api/outcomes');
            const data = await res.json();
            if (data.status !== 'ok') throw new Error(data.message);
            renderOutcomes(data);
        } catch (err) {
            document.getElementById('outcomes-resolved-body').innerHTML =
                `<tr class="state-row"><td colspan="8">Error: ${err.message}</td></tr>`;
        }
    }

    function renderOutcomes(data) {
        const { summary, resolved, pending } = data;
        const fmt = v => (v != null && !isNaN(v)) ? `£${Number(v).toFixed(2)}` : '—';
        const total = summary.total_resolved + summary.total_pending;

        document.getElementById('outcome-stats').innerHTML = `
            <div class="stat-card"><div class="stat-label">Tracked</div><div class="stat-value">${total}</div></div>
            <div class="stat-card"><div class="stat-label">Resolved</div><div class="stat-value">${summary.total_resolved}</div></div>
            <div class="stat-card"><div class="stat-label">Beat Market</div><div class="stat-value green">${summary.beat_market}</div></div>
            <div class="stat-card"><div class="stat-label">Win Rate</div><div class="stat-value ${summary.win_rate >= 50 ? 'green' : 'amber'}">${summary.win_rate}%</div></div>
            <div class="stat-card"><div class="stat-label">Pending</div><div class="stat-value">${summary.total_pending}</div></div>
        `;

        const resolvedBody = document.getElementById('outcomes-resolved-body');
        if (resolved.length === 0) {
            resolvedBody.innerHTML = '<tr class="state-row"><td colspan="8">No resolved deals yet — they appear here once auctions end and the scraper picks them up as sold.</td></tr>';
        } else {
            resolvedBody.innerHTML = resolved.map((r, i) => {
                if (r.EndedUnsold) {
                    // Auction ended without a sale — no final price to compare
                    return `<tr style="animation-delay:${i * 40}ms">
                        <td>${formatDate(r.SurfacedAt)}</td>
                        <td><span class="cat-badge">${r.Category}</span></td>
                        <td><div class="model-cell" style="font-size:14px">${r.Model || '—'}</div></td>
                        <td style="text-align:right">
                            <div class="price-current" style="font-size:13px">${fmt(r.SurfacedPrice)}</div>
                            <div class="price-avg">${r.SurfacedDiscountPct}% off</div>
                        </td>
                        <td style="text-align:right"><div class="price-avg" style="font-size:13px">${fmt(r.AvgMarketPrice)}</div></td>
                        <td style="text-align:right"><div class="price-avg" style="font-size:13px">—</div></td>
                        <td><span class="outcome-ended">ENDED</span></td>
                        <td><a href="${safeUrl(r.URL)}" target="_blank" rel="noopener noreferrer" class="link-btn">VIEW →</a></td>
                    </tr>`;
                }
                const win = r.FinalPrice < r.AvgMarketPrice;
                const pctLabel = r.ActualDiscountPct > 0
                    ? `${r.ActualDiscountPct}% off mkt`
                    : `${Math.abs(r.ActualDiscountPct).toFixed(1)}% over mkt`;
                return `<tr style="animation-delay:${i * 40}ms">
                    <td>${formatDate(r.SurfacedAt)}</td>
                    <td><span class="cat-badge">${r.Category}</span></td>
                    <td><div class="model-cell" style="font-size:14px">${r.Model || '—'}</div></td>
                    <td style="text-align:right">
                        <div class="price-current" style="font-size:13px">${fmt(r.SurfacedPrice)}</div>
                        <div class="price-avg">${r.SurfacedDiscountPct}% off</div>
                    </td>
                    <td style="text-align:right"><div class="price-avg" style="font-size:13px">${fmt(r.AvgMarketPrice)}</div></td>
                    <td style="text-align:right">
                        <div class="${win ? 'gain' : 'price-current'}" style="font-size:13px">${fmt(r.FinalPrice)}</div>
                        <div class="price-avg">${pctLabel}</div>
                    </td>
                    <td><span class="${win ? 'outcome-win' : 'outcome-miss'}">${win ? 'DEAL' : 'MISS'}</span></td>
                    <td><a href="${safeUrl(r.URL)}" target="_blank" rel="noopener noreferrer" class="link-btn">VIEW →</a></td>
                </tr>`;
            }).join('');
        }

        const pendingHeader = document.getElementById('pending-header');
        const pendingWrap   = document.getElementById('pending-wrap');
        if (pending.length > 0) {
            pendingHeader.style.display = '';
            pendingWrap.style.display   = '';
            document.getElementById('outcomes-pending-body').innerHTML = pending.map((r, i) => {
                const ended = !r.EndTime || new Date(r.EndTime) <= Date.now();
                const statusCell = r.GaveUp
                    ? `<span class="outcome-miss">UNRESOLVED</span>`
                    : ended
                        ? `<span class="time-cell urgent">AWAITING</span>`
                        : `<span class="time-cell" data-ends="${r.EndTime}"></span>`;
                return `<tr style="animation-delay:${i * 40}ms">
                    <td>${formatDate(r.SurfacedAt)}</td>
                    <td><span class="cat-badge">${r.Category}</span></td>
                    <td><div class="model-cell" style="font-size:14px">${r.Model || '—'}</div></td>
                    <td style="text-align:right">
                        <div class="price-current" style="font-size:13px">${fmt(r.SurfacedPrice)}</div>
                        <div class="price-avg">${r.SurfacedDiscountPct}% off</div>
                    </td>
                    <td style="text-align:right"><div class="price-avg" style="font-size:13px">${fmt(r.AvgMarketPrice)}</div></td>
                    <td style="text-align:right"><div class="price-avg" style="font-size:13px">${fmt(r.CurrentPrice)}</div></td>
                    <td>${statusCell}</td>
                    <td><a href="${safeUrl(r.URL)}" target="_blank" rel="noopener noreferrer" class="link-btn">VIEW →</a></td>
                </tr>`;
            }).join('');
            tickCountdowns();
        } else {
            pendingHeader.style.display = 'none';
            pendingWrap.style.display   = 'none';
        }
    }

    function formatCountdown(isoStr) {
        if (!isoStr) return '—';
        const diff = Math.floor((new Date(isoStr) - Date.now()) / 1000);
        if (diff <= 0) return 'ENDED';
        const h = Math.floor(diff / 3600);
        const m = Math.floor((diff % 3600) / 60);
        const s = diff % 60;
        if (h > 0) return `${h}h ${String(m).padStart(2, '0')}m ${String(s).padStart(2, '0')}s`;
        if (m > 0) return `${m}m ${String(s).padStart(2, '0')}s`;
        return `${s}s`;
    }

    function tickCountdowns() {
        document.querySelectorAll('[data-ends]').forEach(el => {
            const isoStr = el.dataset.ends;
            const diff = isoStr ? (new Date(isoStr) - Date.now()) / 1000 : -1;
            el.textContent = formatCountdown(isoStr);
            el.classList.toggle('urgent', diff >= 0 && diff < 300);
        });
    }

    function safeUrl(url) {
        try {
            const parsed = new URL(url);
            return (parsed.protocol === 'https:' || parsed.protocol === 'http:') ? url : '#';
        } catch { return '#'; }
    }

    function renderRow(d, type, i) {
        const bigDiscount = d.DiscountPct >= 30;
        const delay       = i * 60;
        const fmt = v => (v != null && !isNaN(v)) ? Number(v).toFixed(2) : '—';
        const prices = `
            <td data-label="Current" style="text-align:right"><div class="price-current">£${fmt(d.CurrentPrice)}</div></td>
            <td data-label="Avg" style="text-align:right"><div class="price-avg">£${fmt(d.AvgMarketPrice)}</div></td>
            <td data-label="Saving" style="text-align:right"><span class="gain">+£${fmt(d.PotentialGain)}</span></td>
            <td data-label="Discount"><span class="discount-badge ${bigDiscount ? 'high' : ''}">${d.DiscountPct}% OFF</span></td>
            <td data-label="Ends In"><span class="time-cell" data-ends="${d.EndTime || ''}"></span></td>
            <td class="card-action"><a href="${safeUrl(d.URL)}" target="_blank" rel="noopener noreferrer" class="link-btn">VIEW →</a></td>`;

        if (type === 'gpu') {
            return `<tr style="animation-delay:${delay}ms">
                <td class="card-title">
                    <div class="model-cell">${d.Model || '—'}</div>
                    <div class="brand-tag">${d.Brand || ''}${d.VRAM ? ' · ' + d.VRAM + 'GB' : ''}</div>
                </td>
                ${prices}
            </tr>`;
        }
        if (type === 'cpu') {
            return `<tr style="animation-delay:${delay}ms">
                <td class="card-title">
                    <div class="model-cell">${d.Model || '—'}</div>
                    <div class="brand-tag">${d.Brand || ''}</div>
                </td>
                <td data-label="Socket">
                    <div class="model-cell" style="font-size:13px">${d.Socket || '—'}</div>
                    <div class="brand-tag">${d.Cores ? d.Cores + ' cores' : ''}</div>
                </td>
                ${prices}
            </tr>`;
        }
        if (type === 'hdd') {
            const cap = d.CapacityGB >= 1000
                ? (d.CapacityGB / 1000).toFixed(d.CapacityGB % 1000 === 0 ? 0 : 1) + 'TB'
                : d.CapacityGB + 'GB';
            return `<tr style="animation-delay:${delay}ms">
                <td class="card-title">
                    <div class="model-cell">${cap} · ${d.Interface || 'SATA'}</div>
                </td>
                <td data-label="Details">
                    <div class="model-cell" style="font-size:13px">${d.Brand || '—'}</div>
                    <div class="brand-tag">${d.FormFactor || ''}${d.RPM ? ' · ' + d.RPM.toLocaleString() + ' rpm' : ''}</div>
                </td>
                ${prices}
            </tr>`;
        }
    }

    function renderDeals(deals, type) {
        const thead = document.getElementById('deals-head');
        const tbody = document.getElementById('deals-body');
        const cols  = COLS[type];

        thead.innerHTML = HEADERS[type];
        document.getElementById('deal-count').textContent = `${deals.length} deal${deals.length !== 1 ? 's' : ''}`;

        if (deals.length === 0) {
            tbody.innerHTML = `<tr class="state-row"><td colspan="${cols}">No deals ending within 2 hours right now. Check back soon.</td></tr>`;
            return;
        }

        tbody.innerHTML = deals.map((d, i) => renderRow(d, type, i)).join('');
        tickCountdowns();
    }

    async function loadTabCounts() {
        try {
            const res  = await fetch('/api/deal-counts');
            const data = await res.json();
            if (data.status !== 'ok') return;
            ['gpu', 'cpu', 'hdd'].forEach(type => {
                const badge = document.getElementById(`badge-${type}`);
                const count = data.counts[type];
                if (count > 0) {
                    badge.textContent = count;
                    badge.classList.add('visible');
                } else {
                    badge.classList.remove('visible');
                }
            });
        } catch {}
    }

    async function loadStats() {
        try {
            const res = await fetch('/api/stats');
            const data = await res.json();
            document.getElementById('stat-active').textContent = data.active_listings.toLocaleString();
            document.getElementById('stat-sold').textContent = data.sold_listings.toLocaleString();
            const d = new Date(data.last_updated);
            document.getElementById('stat-updated').textContent = isNaN(d) ? '—' : d.toLocaleDateString('en-GB', {day:'2-digit', month:'short'});
        } catch {}
    }

    async function loadDeals() {
        const btn  = document.getElementById('refresh-btn');
        const cols = COLS[activeType];
        btn.classList.add('spinning');
        document.getElementById('deals-head').innerHTML = HEADERS[activeType];
        document.getElementById('deals-body').innerHTML =
            `<tr class="state-row"><td colspan="${cols}"><span class="loader"></span> Loading deals...</td></tr>`;
        try {
            const res  = await fetch(`/api/deals?type=${activeType}`);
            const data = await res.json();
            if (data.status === 'ok') {
                renderDeals(data.deals, activeType);
            } else {
                document.getElementById('deals-body').innerHTML =
                    `<tr class="state-row"><td colspan="${cols}">Error: ${data.message}</td></tr>`;
            }
        } catch(err) {
            console.error('loadDeals error:', err);
            document.getElementById('deals-body').innerHTML =
                `<tr class="state-row"><td colspan="${cols}">Error: ${err.message || 'Could not connect to server.'}</td></tr>`;
        } finally {
            btn.classList.remove('spinning');
        }
    }

    loadStats();
    loadDeals();
    loadTabCounts();
    setInterval(tickCountdowns, 1000);
    setInterval(loadDeals, 5 * 60 * 1000);
    setInterval(loadStats, 5 * 60 * 1000);
    setInterval(loadTabCounts, 5 * 60 * 1000);
</script>
</body>
</html>
